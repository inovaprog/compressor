import Head from 'next/head'
import styles from '../styles/Home.module.css'
import { Form, Button } from 'react-bootstrap'
import imageCompression from 'browser-image-compression';
import { useState } from 'react';
import ClipLoader from "react-spinners/ClipLoader";


export default function Home() {
  const [images, setImage] = useState(null)
  const [visibility, setVisibility] = useState("none")
  const [loading, setLoading] = useState(false)
  
  const loadingHandler = (l) => {
    if (l) {
        setLoading(false)
        setVisibility("block")
    }
    else {
        setLoading(true)
        setVisibility("none")
    }
}

  async function upFoto(event) {
    loadingHandler(false)
    var names = []
    var imagesb64 = []
    for (var image of event.target.files) {
      const imageFile = image;
      const options = {
        useWebWorker: true
      }
      try {
        const compressedFile = await imageCompression(imageFile, options);
        var image = await imageCompression.getDataUrlFromFile(compressedFile);
        imagesb64.push({ image: image, name: imageFile.name })
      } catch (error) {
        console.log(error);
      }
    }
    setImage(imagesb64);
    loadingHandler(true)
  }

  function downloadAll() {
    var link = document.createElement('a');
    link.style.display = 'none';
    document.body.appendChild(link);
    for (var n of images) {
      link.setAttribute('download', n.name);
      link.setAttribute('href', n.image);
      link.click();
    }
    document.body.removeChild(link);
  }


  return (
    <div className={styles.container}>
      <Head>
        <title>RadarFit Compressor</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <Form >
        <Form.File onChange={upFoto} style={{ width: "100%", margin: 20 }} id="file" name="file" multiple />
      </Form>
      <ClipLoader loading={loading} size={15} ></ClipLoader>
      <Button style={{display:visibility}} onClick={downloadAll}>  Download</Button>
    </div>
  )
}
